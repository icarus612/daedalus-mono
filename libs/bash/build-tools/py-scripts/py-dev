#!/bin/bash

# Python dev script for monorepo packages
# Activates venv and runs the appropriate dev command

set -e

# Check if venv exists
if [ ! -d ".venv" ]; then
    echo "Virtual environment not found. Running py-install first..."
    pnpm run install
fi

# Activate venv
source .venv/bin/activate

# Determine what to run based on available files
if [ -f "main.py" ]; then
    echo "Running main.py..."
    python main.py
elif [ -d "src" ] && [ -f "src/__init__.py" ]; then
    echo "Running src module..."
    python -m src
elif [ -f "pyproject.toml" ]; then
    # Try to extract module name from pyproject.toml
    MODULE_NAME=$(grep -E '^\[tool\.poetry\]|^name\s*=' pyproject.toml | grep -A1 '\[tool\.poetry\]' | grep 'name' | cut -d'"' -f2 | tr '-' '_')
    if [ -d "$MODULE_NAME" ]; then
        echo "Running module: $MODULE_NAME..."
        python -m "$MODULE_NAME"
    else
        echo "Module directory not found. Starting Python REPL..."
        python
    fi
else
    echo "No clear entry point found. Starting Python REPL..."
    python
fi